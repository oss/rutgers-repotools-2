#!/bin/bash

if [[ "$1" == "-h" || "$1" == "--help" ]]; then
	echo "Usage: pullpackage [koji tag] [RPM name in nvr format]"
	echo "Example: pullpackage centos6-rutgers-testing test-3.0-2.ru6"
	exit 0
fi

if [[ $EUID -ne 0 ]]; then
	echo "This script must be run as root" 1>&2
	exit 1
fi

source /etc/rutgers-repotools-2.cfg

if [[ ! -f "$MASHD$1.mash" ]]; then
	echo "There is no mash file for that repo"
	exit 1
fi

if [[ -f "$LOCK" ]]; then
    echo "Operation on repository alreeady occurring, try again later"
    exit 1
fi

touch $LOCK

echo "Untagging packages"
koji untag-pkg $1 $2

if [[ "$?" != "0" ]]; then
	echo "Failed to untag packages!"
    rm $LOCK
	exit 1
fi

echo "Called rebuild-repo"
rebuild-repo $1 -nolock
if [[ "$?" != "0" ]]; then
	echo "Rebuild-Repo failed!! Retagging package and exiting..."
	koji tag-pkg $1 $2
    echo "Sending Mail"
    echo -e "Pullpackage failed with the following output:\n\nDependency Errors detected:\n$(cat $RDPROB)\n\nOutput from repoclosure:\n$(cat $TMPRPL)" | \
        mailx -r "roji@koji.rutgers.edu" -s "CentOS Borken Dependencies" "anp120@jla.rutgers.edu"
    rm $RDPROB
    rm $TMPRPL
    rm $URDEPS
    rm $LOCK
	exit 1
fi

echo -e "Pullpackage successfully pulled $2 from $1 along with its breakout packages" | \
    mailx -r "roji@koji.rutgers.edu" -s "CentOS Pull Successful - $2" "anp120@jla.rutgers.edu"

rm $RDPROB
rm $TMPRPL
rm $URDEPS
rm $LOCK

echo "Successfully pulled package!"
exit 0
